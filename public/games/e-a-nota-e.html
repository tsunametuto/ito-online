<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>E a nota Ã©...</title>
  <style>
    body{margin:0;font-family:Arial;background:#0b0b0b;color:#eaeaea;text-align:center;padding:18px}
    .wrap{max-width:900px;margin:0 auto}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin:14px 0;text-align:left}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1;min-width:180px}
    button{
      width:100%;box-sizing:border-box;padding:12px;border-radius:10px;
      border:1px solid #333;background:#1f1f1f;color:#fff;font-size:16px
    }
    button{cursor:pointer}
    button:hover{background:#2a2a2a}
    .muted{color:#aaa;font-size:13px;line-height:1.4}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #333;border-radius:999px;font-size:12px;color:#aaa;margin-left:6px}
    .players{display:flex;flex-wrap:wrap;gap:8px}
    .p{border:1px solid #333;border-radius:999px;padding:6px 10px;font-size:13px}
    .p.master{border-color:#f1c40f}
    .p.off{opacity:.55}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0}
    .big{font-size:22px;font-weight:900}
    .center{text-align:center}
    .hidden{display:none !important}

    /* feedback botÃ£o clicado (contorno) */
    button.pressed{
      outline: 2px solid #7a5cff;
      border-color: #7a5cff !important;
      box-shadow: 0 0 0 2px rgba(122,92,255,.15);
    }
    button.good-pressed{
      outline: 2px solid #2ecc71;
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 2px rgba(46,204,113,.15);
    }
    button.bad-pressed{
      outline: 2px solid #ff4d4d;
      border-color: #ff4d4d !important;
      box-shadow: 0 0 0 2px rgba(255,77,77,.15);
    }

    /* BotÃµes 1-10 */
    .grid10{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:720px){ .grid10{grid-template-columns:repeat(2,1fr);} }
    .numBtn{padding:14px;font-weight:900;font-size:18px}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1a1a1a;padding:10px;text-align:left;font-size:14px}
    th{color:#aaa;font-weight:700}
    .right{text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 0 0;">E A NOTA Ã‰...</h1>
    <div class="muted" id="subtitle">Carregandoâ€¦</div>

    <div class="card">
      <div class="title">Sala</div>
      <div class="muted">
        CÃ³digo: <b id="roomCode">------</b>
        <span class="pill" id="rolePill">conectandoâ€¦</span>
        <span class="pill" id="phasePill">fase: lobby</span>
      </div>
    </div>

    <div class="card">
      <div class="title">Jogadores</div>
      <div class="players" id="players"></div>

      <!-- âœ… mestre: comeÃ§a escondido de verdade -->
      <div class="row" style="margin-top:12px;" id="masterControls" class="hidden" hidden>
        <button id="btnStart">Iniciar turno</button>
        <button id="btnReveal">Revelar</button>
        <button id="btnNext">PrÃ³ximo turno</button>
        <button id="btnResetScores">Zerar placar</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnLeave">Sair</button>
      </div>

      <div class="muted" style="margin-top:10px" id="kickHint" hidden>
        Clique em um jogador para expulsar (sÃ³ o mestre).
      </div>
    </div>

    <div class="card" id="scoreCard">
      <div class="title">Placar</div>
      <div class="muted" style="margin-bottom:8px;">Quem acertar ganha +1. O alvo ganha 1 + acertos.</div>
      <div id="scoreTableWrap"></div>
    </div>

    <div class="card" id="turnCard">
      <div class="title">Turno</div>

      <div class="center">
        <div class="muted" id="turnLine">Aguardando o mestre iniciarâ€¦</div>
        <div class="big" id="bigBox" style="margin-top:10px;">â€”</div>
      </div>

      <div id="guessUI" class="hidden" style="margin-top:14px;">
        <div class="muted center" style="margin-bottom:10px;">Escolha sua nota:</div>
        <div class="grid10" id="gridBtns"></div>
        <div class="muted center" id="guessStatus" style="margin-top:10px;"></div>
      </div>

      <div id="revealUI" class="hidden" style="margin-top:14px;">
        <div class="title">Resultado</div>
        <div class="big" id="revealLine1">â€”</div>
        <div class="muted" id="revealLine2" style="margin-top:8px;"></div>
        <div id="guessList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function getOrCreatePlayerToken(){
      let t = localStorage.getItem("tbr_player_token");
      if (!t) {
        t = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random())).toString();
        localStorage.setItem("tbr_player_token", t);
      }
      return t;
    }

    function setPressed(btn, type = "normal") {
      if (!btn) return;
      document.querySelectorAll("#masterControls button, #btnLeave, .numBtn").forEach(b => {
        b.classList.remove("pressed", "good-pressed", "bad-pressed");
      });
      if (type === "good") btn.classList.add("good-pressed");
      else if (type === "bad") btn.classList.add("bad-pressed");
      else btn.classList.add("pressed");
    }

    const roomId = qs("room").toUpperCase();
    const nickname = qs("name").trim();

    // âœ… token consistente (nÃ£o dependa de ?token)
    const playerToken = getOrCreatePlayerToken();

    // sessionKey segue sua lÃ³gica padrÃ£o
    const sessionKey = qs("sessionKey") || sessionStorage.getItem(`tbr_session_${roomId}`) || "";

    document.getElementById("roomCode").textContent = roomId || "------";
    document.getElementById("subtitle").textContent = nickname ? `VocÃª: ${nickname}` : "â€”";

    // entra por sessionKey
    socket.emit("joinRoom", {
      roomId,
      password: "",
      playerName: nickname,
      playerToken,
      sessionKey
    });

    let isMaster = false;
    let playersCache = [];
    let lastState = null;
    let myGuess = null;

    function renderPlayers(list){
      const wrap = document.getElementById("players");
      wrap.innerHTML = "";
      playersCache = list || [];

      playersCache.forEach(p => {
        const el = document.createElement("div");
        el.className = "p" + (p.isMaster ? " master":"") + (p.online ? "" : " off");
        el.textContent = p.name + (p.isMaster ? " ðŸ‘‘" : "") + (p.online ? "" : " (off)");

        if (isMaster && !p.isMaster) {
          el.style.cursor = "pointer";
          el.title = "Clique para expulsar";
          el.onclick = () => {
            const ok = confirm(`Expulsar ${p.name}?`);
            if (!ok) return;
            socket.emit("kickPlayer", { roomId, targetToken: p.token });
          };
        }

        wrap.appendChild(el);
      });
    }

    function renderScoreboard(scoreboard){
      const wrap = document.getElementById("scoreTableWrap");
      if (!scoreboard || !scoreboard.length) {
        wrap.innerHTML = `<div class="muted">Sem dados.</div>`;
        return;
      }
      const rows = scoreboard.map((x, i) => `
        <tr>
          <td>${i+1}Âº</td>
          <td>${x.name}${x.online ? "" : " <span class='muted'>(off)</span>"}</td>
          <td class="right"><b>${x.points}</b></td>
        </tr>
      `).join("");
      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Jogador</th>
              <th class="right">Pontos</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function isMeTarget(state){
      if (!state || !state.targetToken) return false;
      return state.targetToken === playerToken;
    }

    function showGuessUI(show){
      document.getElementById("guessUI").classList.toggle("hidden", !show);
    }
    function showRevealUI(show){
      document.getElementById("revealUI").classList.toggle("hidden", !show);
    }

    function clearMySecretNumberUI(){
      // âœ… limpa SUA NOTA de rodadas anteriores
      const bigBox = document.getElementById("bigBox");
      // sÃ³ limpa se estiver mostrando algo do tipo "SUA NOTA"
      if ((bigBox.textContent || "").toUpperCase().includes("SUA NOTA")) {
        bigBox.textContent = "â€”";
      }
    }

    // BotÃµes mestre
    const btnStart = document.getElementById("btnStart");
    const btnReveal = document.getElementById("btnReveal");
    const btnNext = document.getElementById("btnNext");
    const btnResetScores = document.getElementById("btnResetScores");
    const btnLeave = document.getElementById("btnLeave");

    btnStart.onclick = () => {
      setPressed(btnStart);
      socket.emit("notaStartTurn", roomId);
    };
    btnReveal.onclick = () => {
      setPressed(btnReveal, "bad");
      socket.emit("notaReveal", roomId);
    };
    btnNext.onclick = () => {
      setPressed(btnNext);
      socket.emit("notaNextTurn", roomId);
    };
    btnResetScores.onclick = () => {
      const ok = confirm("Zerar placar?");
      if (!ok) return;
      setPressed(btnResetScores, "bad");
      socket.emit("notaResetScores", roomId);
    };

    btnLeave.onclick = () => {
      setPressed(btnLeave, "bad");
      socket.emit("leaveRoom", roomId);
      window.location.href = "/";
    };

    // cria botÃµes 1..10
    const grid = document.getElementById("gridBtns");
    for (let n = 1; n <= 10; n++) {
      const b = document.createElement("button");
      b.className = "numBtn";
      b.textContent = String(n);
      b.onclick = () => {
        myGuess = n;
        setPressed(b, "good");
        socket.emit("notaSubmitGuess", { roomId, guess: n });
      };
      grid.appendChild(b);
    }

    // Eventos gerais
    socket.on("errorMessage", (m) => alert(m));

    socket.on("joinedRoom", ({ sessionKey }) => {
      // salva sessionKey (igual seus outros jogos)
      if (sessionKey && roomId) {
        sessionStorage.setItem(`tbr_session_${roomId}`, sessionKey);
      }
    });

    // âœ… Somente o mestre recebe este evento, entÃ£o Ã© o â€œgateâ€ oficial.
    socket.on("master", () => {
      isMaster = true;
      document.getElementById("rolePill").textContent = "mestre ðŸ‘‘";
      document.getElementById("masterControls").hidden = false;
      document.getElementById("kickHint").hidden = false;
    });

    socket.on("playersUpdate", ({ players, gameType }) => {
      if (gameType && gameType !== "e-a-nota-e") return;
      document.getElementById("rolePill").textContent = isMaster ? "mestre ðŸ‘‘" : "jogador";
      renderPlayers(players);
    });

    socket.on("roomClosed", () => {
      alert("A sala foi fechada.");
      window.location.href = "/";
    });

    socket.on("kicked", ({ reason }) => {
      alert(reason || "VocÃª foi expulso.");
      window.location.href = "/";
    });

    // âœ… Estado do jogo
    socket.on("notaState", (state) => {
      lastState = state;

      const phase = state?.phase || "lobby";
      document.getElementById("phasePill").textContent = "fase: " + phase;

      // âœ… placar
      renderScoreboard(state.scoreboard);

      const turnLine = document.getElementById("turnLine");
      const bigBox = document.getElementById("bigBox");
      const guessStatus = document.getElementById("guessStatus");

      if (phase !== "revealed") {
        showRevealUI(false);
      }

      if (phase === "lobby") {
        showGuessUI(false);
        turnLine.textContent = "Aguardando o mestre iniciarâ€¦";
        bigBox.textContent = "â€”";
        guessStatus.textContent = "";
        clearMySecretNumberUI();
      }

      if (phase === "guessing") {
        const targetName = state.targetName || "Jogador";
        const meIsTarget = isMeTarget(state);

        if (meIsTarget) {
          showGuessUI(false);
          turnLine.textContent = `VocÃª Ã© o alvo desta vez.`;
          // o nÃºmero vem pelo evento notaSecret, mas se ele ainda nÃ£o chegou, deixa esse placeholder
          if (!String(bigBox.textContent || "").toUpperCase().includes("SUA NOTA")) {
            bigBox.textContent = "Sua nota estÃ¡ na sua tela âœ…";
          }
        } else {
          // âœ… se eu NÃƒO sou alvo, garanta que NÃƒO fique mostrando SUA NOTA antiga
          clearMySecretNumberUI();

          showGuessUI(true);
          turnLine.textContent = `Chute a nota de: ${targetName}`;
          bigBox.textContent = "Escolha 1 a 10";

          const already = !!state.submitted?.[playerToken];
          guessStatus.textContent = already ? "Enviado âœ…" : "Ainda nÃ£o enviadoâ€¦";
        }
      }

      if (phase === "revealed") {
        showGuessUI(false);
        turnLine.textContent = "Resultado revelado.";
        // evita ficar preso com SUA NOTA
        bigBox.textContent = "â€”";
      }
    });

    // âœ… Segredo do alvo (sÃ³ aplica se eu for alvo AGORA)
    socket.on("notaSecret", ({ rating }) => {
      const bigBox = document.getElementById("bigBox");
      if (lastState?.phase !== "guessing") return;
      if (!isMeTarget(lastState)) return; // âœ… nÃ£o deixa â€œSUA NOTAâ€ vazar pra quem nÃ£o Ã© alvo
      bigBox.textContent = `SUA NOTA: ${rating}`;
    });

    socket.on("notaPromptGuess", ({ targetName }) => {
      const turnLine = document.getElementById("turnLine");
      if (lastState?.phase === "guessing" && !isMeTarget(lastState)) {
        turnLine.textContent = `Chute a nota de: ${targetName || "Jogador"}`;
      }
    });

    socket.on("notaGuessOK", () => {
      document.getElementById("guessStatus").textContent = "Enviado âœ…";
    });

    socket.on("notaTurnStarted", () => {
      // âœ… limpa seleÃ§Ã£o visual de botÃµes 1-10
      document.querySelectorAll(".numBtn").forEach(b => {
        b.classList.remove("pressed", "good-pressed", "bad-pressed");
      });

      myGuess = null;
      document.getElementById("guessStatus").textContent = "";
      document.getElementById("revealLine1").textContent = "â€”";
      document.getElementById("revealLine2").textContent = "";
      document.getElementById("guessList").innerHTML = "";

      // âœ… MUITO IMPORTANTE: limpar qualquer SUA NOTA antiga imediatamente ao iniciar turno novo
      clearMySecretNumberUI();
      // e tambÃ©m tirar resultado antigo da tela
      showRevealUI(false);
    });

    socket.on("notaRevealed", ({ targetName, rating, hits, guesses, addedToTarget }) => {
      showRevealUI(true);

      document.getElementById("revealLine1").textContent = `${targetName} recebeu: ${rating}`;
      document.getElementById("revealLine2").textContent = `Acertos: ${hits}. (+${addedToTarget} pro alvo)`;

      const list = (guesses || []).map(g =>
        `<div class="muted" style="padding:6px 0;border-bottom:1px solid #1a1a1a;">
          <b>${g.name}</b> â†’ ${g.guess} ${g.hit ? "âœ…" : ""}
        </div>`
      ).join("");

      document.getElementById("guessList").innerHTML =
        list || `<div class="muted">NinguÃ©m enviou chute.</div>`;

      // âœ… garantir que apÃ³s revelar, nÃ£o fique SUA NOTA antiga
      const bigBox = document.getElementById("bigBox");
      bigBox.textContent = "â€”";
    });

    socket.on("notaTurnCancelled", (msg) => {
      alert(msg || "Turno cancelado.");
      // limpa UI
      showGuessUI(false);
      showRevealUI(false);
      document.getElementById("turnLine").textContent = "Aguardando o mestre iniciarâ€¦";
      document.getElementById("bigBox").textContent = "â€”";
      document.getElementById("guessStatus").textContent = "";
      clearMySecretNumberUI();
    });

    socket.on("notaTargetLeft", (msg) => {
      alert(msg || "O alvo saiu. Pulando turno...");
      // limpa SUA NOTA antiga tambÃ©m
      clearMySecretNumberUI();
    });

    socket.on("notaScoresReset", () => {
      alert("Placar zerado.");
    });
  </script>
</body>
</html>
