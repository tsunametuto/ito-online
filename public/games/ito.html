<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>De 1 a 100</title>
  <style>
    body{margin:0;font-family:Arial;background:#0b0b0b;color:#eaeaea;text-align:center;padding:18px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin:14px 0;text-align:left}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1;min-width:180px}
    button,input{
      width:100%;box-sizing:border-box;padding:12px;border-radius:10px;
      border:1px solid #333;background:#1f1f1f;color:#fff;font-size:16px
    }
    button{cursor:pointer}
    button:hover{background:#2a2a2a}
    .muted{color:#aaa;font-size:13px;line-height:1.4}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #333;border-radius:999px;font-size:12px;color:#aaa;margin-left:6px}
    .players{display:flex;flex-wrap:wrap;gap:8px}
    .p{border:1px solid #333;border-radius:999px;padding:6px 10px;font-size:13px}
    .p.master{border-color:#f1c40f}
    .p.off{opacity:.55}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0}
    .big{font-size:20px;font-weight:900}
    .center{text-align:center}

    /* feedback botÃ£o clicado (mesmo estilo que vocÃª curte) */
    button.pressed{
      outline: 2px solid #7a5cff;
      border-color: #7a5cff !important;
      box-shadow: 0 0 0 2px rgba(122,92,255,.15);
    }
    button.good-pressed{
      outline: 2px solid #2ecc71;
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 2px rgba(46,204,113,.15);
    }
    button.bad-pressed{
      outline: 2px solid #ff4d4d;
      border-color: #ff4d4d !important;
      box-shadow: 0 0 0 2px rgba(255,77,77,.15);
    }

    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 0 0;">DE 1 A 100</h1>
    <div class="muted" id="subtitle">Carregandoâ€¦</div>

    <div class="card">
      <div class="title">Sala</div>
      <div class="muted">
        CÃ³digo: <b id="roomCode">------</b>
        <span class="pill" id="rolePill">conectandoâ€¦</span>
      </div>
    </div>

    <div class="card">
      <div class="title">Jogadores</div>
      <div class="players" id="players"></div>

      <!-- âœ… mestre: comeÃ§a escondido de verdade -->
      <div class="row hidden" style="margin-top:12px;" id="masterControls" hidden>
        <button id="btnDistribute">Iniciar rodada (distribuir)</button>
        <button id="btnReveal">Revelar</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnLeave">Sair</button>
      </div>

      <div class="muted" style="margin-top:10px" id="kickHint" hidden>
        Clique em um jogador acima para expulsar (sÃ³ o mestre vÃª isso).
      </div>
    </div>

    <div class="card">
      <div class="title">Seu nÃºmero</div>
      <div class="center">
        <div class="big" id="yourNumber">â€”</div>
        <div class="muted" style="margin-top:8px;">NÃ£o fale seu nÃºmero â€” tente ordenar na conversa ðŸ™‚</div>
      </div>
    </div>

    <div class="card" id="revealBox" hidden>
      <div class="title">RevelaÃ§Ã£o</div>
      <div id="revealList" class="muted"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function setPressed(btn, type = "normal") {
      if (!btn) return;
      document.querySelectorAll("#masterControls button, #btnLeave").forEach(b => {
        b.classList.remove("pressed", "good-pressed", "bad-pressed");
      });
      if (type === "good") btn.classList.add("good-pressed");
      else if (type === "bad") btn.classList.add("bad-pressed");
      else btn.classList.add("pressed");
    }

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    function getOrCreatePlayerToken(){
      let t = localStorage.getItem("tbr_player_token");
      if (!t) {
        t = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random())).toString();
        localStorage.setItem("tbr_player_token", t);
      }
      return t;
    }

    const roomId = qs("room").toUpperCase();
    const nickname = (qs("name") || "").trim();
    const playerToken = getOrCreatePlayerToken();
    const sessionKey = qs("sessionKey") || sessionStorage.getItem(`tbr_session_${roomId}`) || "";

    document.getElementById("roomCode").textContent = roomId || "------";
    document.getElementById("subtitle").textContent = nickname ? `VocÃª: ${nickname}` : "â€”";

    // entra na sala via sessionKey (sem senha)
    socket.emit("joinRoom", {
      roomId,
      password: "",
      playerName: nickname,
      playerToken,
      sessionKey
    });

    let isMaster = false;
    let playersCache = [];

    const rolePillEl = document.getElementById("rolePill");
    const masterControlsEl = document.getElementById("masterControls");
    const kickHintEl = document.getElementById("kickHint");

    function setMasterUI(flag){
      isMaster = !!flag;

      rolePillEl.textContent = isMaster ? "mestre ðŸ‘‘" : "jogador";

      masterControlsEl.hidden = !isMaster;
      masterControlsEl.classList.toggle("hidden", !isMaster);

      kickHintEl.hidden = !isMaster;

      if (playersCache.length) renderPlayers(playersCache);
    }

    function clearReveal(){
      document.getElementById("revealBox").hidden = true;
      document.getElementById("revealList").innerHTML = "";
    }

    function renderPlayers(list){
      const wrap = document.getElementById("players");
      wrap.innerHTML = "";
      playersCache = list || [];

      playersCache.forEach(p => {
        const el = document.createElement("div");
        el.className = "p" + (p.isMaster ? " master":"") + (p.online ? "" : " off");
        el.textContent = p.name + (p.isMaster ? " ðŸ‘‘" : "") + (p.online ? "" : " (off)");

        if (isMaster && !p.isMaster) {
          el.style.cursor = "pointer";
          el.title = "Clique para expulsar";
          el.onclick = () => {
            const ok = confirm(`Expulsar ${p.name}?`);
            if (!ok) return;
            socket.emit("kickPlayer", { roomId, targetToken: p.token });
          };
        }

        wrap.appendChild(el);
      });
    }

    // âœ… ignore totalmente o evento `master` (nÃ£o confie nele)
    socket.on("master", () => {
      // nÃ£o faz nada; mestre real vem do playersUpdate
    });

    // gate extra: se nÃ£o for mestre, nÃ£o executa
    function masterOnly(fn){
      return (...args) => {
        if (!isMaster) return;
        fn(...args);
      };
    }

    const btnDistribute = document.getElementById("btnDistribute");
    const btnReveal = document.getElementById("btnReveal");
    const btnLeave = document.getElementById("btnLeave");

    btnDistribute.onclick = masterOnly(() => {
      setPressed(btnDistribute);
      clearReveal();
      socket.emit("distribute", roomId);
    });

    btnReveal.onclick = masterOnly(() => {
      setPressed(btnReveal, "good");
      socket.emit("reveal", roomId);
    });

    btnLeave.onclick = () => {
      setPressed(btnLeave, "bad");
      socket.emit("leaveRoom", roomId);
      window.location.href = "/";
    };

    socket.on("errorMessage", (m) => alert(m));

    socket.on("joinedRoom", ({ sessionKey }) => {
      if (sessionKey && roomId) {
        sessionStorage.setItem(`tbr_session_${roomId}`, sessionKey);
      }
    });

    socket.on("roomClosed", () => {
      alert("A sala foi fechada.");
      window.location.href = "/";
    });

    socket.on("kicked", ({ reason }) => {
      alert(reason || "VocÃª foi expulso.");
      window.location.href = "/";
    });

    socket.on("playersUpdate", ({ players, gameType }) => {
      if (gameType && gameType !== "ito") return;

      renderPlayers(players);

      const me = (players || []).find(p => p.token === playerToken);
      const amIMaster = !!me?.isMaster;

      if (amIMaster !== isMaster) setMasterUI(amIMaster);
      else rolePillEl.textContent = isMaster ? "mestre ðŸ‘‘" : "jogador";
    });

    socket.on("number", (n) => {
      clearReveal();
      document.getElementById("yourNumber").textContent = String(n ?? "â€”");
    });

    socket.on("itoNewRound", () => {
      clearReveal();
    });

    socket.on("allNumbers", (list) => {
      const box = document.getElementById("revealBox");
      const ul = document.getElementById("revealList");
      box.hidden = false;

      if (!Array.isArray(list) || !list.length) {
        ul.innerHTML = "<div>Nada para revelar.</div>";
        return;
      }

      ul.innerHTML = list.map(x => {
        const name = (x && x.name) ? x.name : "Jogador";
        const num = (x && x.number != null) ? x.number : "â€”";
        return `<div><b>${name}</b>: ${num}</div>`;
      }).join("");
    });

    // âœ… estado inicial: garante oculto atÃ© chegar playersUpdate
    setMasterUI(false);
  </script>
</body>
</html>
