<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infiltrado</title>
  <style>
    body{margin:0;font-family:Arial;background:#0b0b0b;color:#eaeaea;text-align:center;padding:18px}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin:14px 0;text-align:left}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1;min-width:180px}
    button,input{
      width:100%;box-sizing:border-box;padding:12px;border-radius:10px;
      border:1px solid #333;background:#1f1f1f;color:#fff;font-size:16px
    }
    button{cursor:pointer}
    button:hover{background:#2a2a2a}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:#aaa;font-size:13px;line-height:1.4}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #333;border-radius:999px;font-size:12px;color:#aaa;margin-left:6px}
    .players{display:flex;flex-wrap:wrap;gap:8px}
    .p{border:1px solid #333;border-radius:999px;padding:6px 10px;font-size:13px}
    .p.master{border-color:#f1c40f}
    .p.off{opacity:.55}
    .title{font-size:18px;font-weight:800;margin:0 0 6px 0}

    /* feedback botÃ£o clicado */
    button.pressed{
      outline: 2px solid #7a5cff;
      border-color: #7a5cff !important;
      box-shadow: 0 0 0 2px rgba(122,92,255,.15);
    }
    button.good-pressed{
      outline: 2px solid #2ecc71;
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 2px rgba(46,204,113,.15);
    }
    button.bad-pressed{
      outline: 2px solid #ff4d4d;
      border-color: #ff4d4d !important;
      box-shadow: 0 0 0 2px rgba(255,77,77,.15);
    }

    .big{font-size:20px;font-weight:900}
    .center{text-align:center}

    .voteGrid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .voteGrid button{
      width:auto;
      min-width:160px;
      flex:1;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 0 0;">INFILTRADO</h1>
    <div class="muted" id="subtitle">Carregandoâ€¦</div>

    <div class="card">
      <div class="title">Sala</div>
      <div class="muted">
        CÃ³digo: <b id="roomCode">------</b>
        <span class="pill" id="rolePill">conectandoâ€¦</span>
      </div>
    </div>

    <div class="card">
      <div class="title">Jogadores</div>
      <div class="players" id="players"></div>

      <div class="row" style="margin-top:12px;" id="masterControls" hidden>
        <button id="btnStart">Iniciar rodada</button>
        <button id="btnNextQ">PrÃ³xima pergunta</button>
        <button id="btnRevealInfil">Revelar infiltrado</button>
        <button id="btnRevealConcepts">Revelar respostas</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnLeave">Sair</button>
      </div>

      <div class="muted" style="margin-top:10px" id="kickHint" hidden>
        Clique em um jogador acima para expulsar (sÃ³ o mestre vÃª isso).
      </div>
    </div>

    <div class="card">
      <div class="title">Sua informaÃ§Ã£o</div>
      <div class="center">
        <div class="muted" style="margin-bottom:6px;">O seu tema/conceito aparece aqui (sÃ³ vocÃª vÃª).</div>
        <div class="big" id="yourInfo">â€”</div>
      </div>
    </div>

    <div class="card">
      <div class="title">Pergunta atual</div>
      <div class="big center" id="questionBox">â€”</div>
      <div class="muted center" id="orderBox" style="margin-top:10px;">â€”</div>
    </div>

    <!-- âœ… VOTAÃ‡ÃƒO -->
    <div class="card" id="voteCard" hidden>
      <div class="title">VotaÃ§Ã£o</div>
      <div class="muted">
        Vote em quem vocÃª acha que Ã© o infiltrado. VocÃª pode votar em vocÃª e trocar o voto.
      </div>

      <div class="voteGrid" id="voteGrid"></div>

      <div class="muted" style="margin-top:10px" id="voteStatus">â€”</div>
    </div>

    <div class="card" id="revealBox" hidden>
      <div class="title">RevelaÃ§Ã£o</div>
      <div class="big" id="revealLine1">â€”</div>
      <div class="big" id="revealLine2" style="margin-top:10px;">â€”</div>
      <div class="muted" style="margin-top:10px">
        (O mestre controla o que revelar e quando.)
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || "";
    }

    const roomId = qs("room").toUpperCase();
    const nickname = qs("name") || "";
    const playerToken = qs("token") || localStorage.getItem("tbr_player_token") || "";
    const sessionKey = qs("sessionKey") || sessionStorage.getItem(`tbr_session_${roomId}`) || "";

    document.getElementById("roomCode").textContent = roomId || "------";
    document.getElementById("subtitle").textContent = nickname ? `VocÃª: ${nickname}` : "â€”";

    // tenta entrar sem senha (sessionKey)
    socket.emit("joinRoom", {
      roomId,
      password: "",
      playerName: nickname,
      playerToken,
      sessionKey
    });

    // UI refs
    const rolePill = document.getElementById("rolePill");
    const masterControls = document.getElementById("masterControls");
    const kickHint = document.getElementById("kickHint");

    const btnStart = document.getElementById("btnStart");
    const btnNextQ = document.getElementById("btnNextQ");
    const btnRevealInfil = document.getElementById("btnRevealInfil");
    const btnRevealConcepts = document.getElementById("btnRevealConcepts");
    const btnLeave = document.getElementById("btnLeave");

    const voteCard = document.getElementById("voteCard");
    const voteGrid = document.getElementById("voteGrid");
    const voteStatus = document.getElementById("voteStatus");

    let isMaster = false;
    let lastPlayers = [];
    let lastMasterToken = null;
    let lastState = null; // infiltradoState

    function clearPressedInMasterRow(){
      document.querySelectorAll("#masterControls button, #btnLeave").forEach(b => {
        b.classList.remove("pressed","good-pressed","bad-pressed");
      });
    }

    function setPressed(btn, type = "normal") {
      if (!btn) return;
      clearPressedInMasterRow();
      if (type === "good") btn.classList.add("good-pressed");
      else if (type === "bad") btn.classList.add("bad-pressed");
      else btn.classList.add("pressed");
    }

    function updateMasterVisibility(){
      masterControls.hidden = !isMaster;
      kickHint.hidden = !isMaster;
      rolePill.textContent = isMaster ? "mestre ðŸ‘‘" : "jogador";
    }

    function renderPlayers(list){
      const wrap = document.getElementById("players");
      wrap.innerHTML = "";
      lastPlayers = list;

      list.forEach(p => {
        const el = document.createElement("div");
        el.className = "p" + (p.isMaster ? " master":"") + (p.online ? "" : " off");
        el.textContent = p.name + (p.isMaster ? " ðŸ‘‘" : "") + (p.online ? "" : " (off)");

        // expulsar (apenas mestre)
        if (isMaster && !p.isMaster) {
          el.style.cursor = "pointer";
          el.title = "Clique para expulsar";
          el.onclick = () => {
            const ok = confirm(`Expulsar ${p.name}?`);
            if (!ok) return;
            socket.emit("kickPlayer", { roomId, targetToken: p.token });
          };
        }

        wrap.appendChild(el);
      });
    }

    function phaseAllowsVoting(phase){
      return ["round1","round2","round3","voting"].includes(phase);
    }

    function renderVoteUI(){
      if (!lastState) return;

      const phase = lastState.phase;
      const players = lastState.players || [];
      const votesByVoter = lastState.votesByVoter || {};

      // mostra card sÃ³ quando a rodada comeÃ§ou (nÃ£o no lobby)
      const show = phaseAllowsVoting(phase);
      voteCard.hidden = !show;
      if (!show) return;

      const activePlayers = players.filter(p => p.isActive && p.online);
      const myVote = votesByVoter[playerToken] || null;

      voteGrid.innerHTML = "";

      activePlayers.forEach(p => {
        const b = document.createElement("button");
        b.textContent = p.name;
        b.onclick = () => {
          socket.emit("infiltradoVote", { roomId, targetToken: p.token });
        };

        // destaque do voto
        if (myVote && myVote === p.token) b.classList.add("bad-pressed");

        voteGrid.appendChild(b);
      });

      const myVoteName =
        myVote ? (activePlayers.find(x => x.token === myVote)?.name || "â€”") : "â€”";

      voteStatus.textContent =
        `Seu voto: ${myVoteName} â€¢ VocÃª pode trocar quando quiser.`;
    }

    function updateMasterButtonsEnabled(){
      // sÃ³ o mestre vÃª os botÃµes, mas ainda assim:
      if (!isMaster || !lastState) return;

      const phase = lastState.phase;

      btnStart.disabled = phase !== "lobby";
      btnNextQ.disabled = !["round1","round2","round3"].includes(phase);

      // pode revelar infiltrado a partir do round1 em diante
      btnRevealInfil.disabled = !phaseAllowsVoting(phase);

      // revelar respostas sÃ³ depois de "revealed" (ou seja: depois de revelar infiltrado)
      // seu server bloqueia isso com phase !== "revealed"
      btnRevealConcepts.disabled = (phase !== "revealed");
    }

    // BotÃµes (mestre)
    btnStart.onclick = () => {
      setPressed(btnStart);
      socket.emit("infiltradoStartRound", roomId);
    };

    btnNextQ.onclick = () => {
      setPressed(btnNextQ);
      socket.emit("infiltradoNextQuestion", roomId);
    };

    btnRevealInfil.onclick = () => {
      setPressed(btnRevealInfil, "bad");
      socket.emit("infiltradoReveal", roomId);
    };

    btnRevealConcepts.onclick = () => {
      setPressed(btnRevealConcepts, "good");
      socket.emit("infiltradoRevealConcepts", roomId);
    };

    // Sair
    btnLeave.onclick = () => {
      setPressed(btnLeave, "bad");
      socket.emit("leaveRoom", roomId);
      window.location.href = "/";
    };

    // Eventos gerais
    socket.on("errorMessage", (m) => alert(m));

    socket.on("roomClosed", () => {
      alert("A sala foi fechada.");
      window.location.href = "/";
    });

    socket.on("kicked", ({ reason }) => {
      alert(reason || "VocÃª foi expulso.");
      window.location.href = "/";
    });

    // âœ… AtualizaÃ§Ã£o de jogadores: Ã© aqui que definimos se Ã© mestre (sem depender do evento "master")
    socket.on("playersUpdate", ({ players, masterToken, gameType }) => {
      if (gameType && gameType !== "infiltrado") return;

      lastMasterToken = masterToken || null;
      isMaster = !!masterToken && (masterToken === playerToken);

      updateMasterVisibility();
      renderPlayers(players || []);
      updateMasterButtonsEnabled();
    });

    // âœ… Estado do jogo (server manda isso sempre que muda algo)
    socket.on("infiltradoState", (state) => {
      lastState = state;

      renderVoteUI();
      updateMasterButtonsEnabled();
    });

    // âœ… segredo individual (sua info)
    socket.on("infiltradoSecret", (payload) => {
      const el = document.getElementById("yourInfo");
      if (!payload) { el.textContent = "â€”"; return; }

      if (payload.role === "infiltrado") {
        el.textContent = `VocÃª Ã© o INFILTRADO â€” Tema: ${payload.themeName} â€” Pista: ${payload.hint}`;
      } else {
        el.textContent = `Tema: ${payload.themeName} â€” Conceito: ${payload.concept}`;
      }
    });

    // âœ… rodada/pergunta atual + ordem
    socket.on("infiltradoRound", ({ round, question, order }) => {
      document.getElementById("questionBox").textContent = question || "â€”";
      const orderText = (order && order.length) ? `Ordem (rodada ${round}): ${order.join(" â†’ ")}` : "â€”";
      document.getElementById("orderBox").textContent = orderText;

      // reseta box de revelaÃ§Ã£o ao avanÃ§ar rodada
      document.getElementById("revealBox").hidden = true;
      document.getElementById("revealLine1").textContent = "â€”";
      document.getElementById("revealLine2").textContent = "â€”";
    });

    socket.on("infiltradoVotingOpened", () => {
      document.getElementById("questionBox").textContent = "VotaÃ§Ã£o aberta!";
      document.getElementById("orderBox").textContent = "Conversem e votem no infiltrado.";
    });

    socket.on("infiltradoNeedResolve", (reason) => {
      alert(reason || "NÃ£o foi possÃ­vel revelar (empate/sem votos).");
    });

    socket.on("infiltradoRoundCancelled", (msg) => {
      alert(msg || "Rodada cancelada.");
      document.getElementById("questionBox").textContent = "â€”";
      document.getElementById("orderBox").textContent = "â€”";
      voteCard.hidden = true;
    });

    // âœ… RevelaÃ§Ã£o 1: sÃ³ o infiltrado (sem conceito)
    socket.on("infiltradoInfiltratorRevealed", ({ infiltradoName, topVotedName }) => {
      document.getElementById("revealBox").hidden = false;
      document.getElementById("revealLine1").textContent = `INFILTRADO: ${infiltradoName || "â€”"}`;
      document.getElementById("revealLine2").textContent =
        `Mais votado: ${topVotedName || "â€”"} â€” (respostas ainda nÃ£o reveladas)`;
    });

    // âœ… RevelaÃ§Ã£o 2: tema/conceito/pista
    socket.on("infiltradoConceptsRevealed", ({ themeName, concept, infiltradoHint }) => {
      document.getElementById("revealBox").hidden = false;
      document.getElementById("revealLine1").textContent = `Tema: ${themeName || "â€”"}`;
      document.getElementById("revealLine2").textContent =
        `Conceito: ${concept || "â€”"} | Pista do infiltrado: ${infiltradoHint || "â€”"}`;
    });
  </script>
</body>
</html>
