<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBR</title>
  <style>
    :root{
      --bg:#050505;
      --accent:#5b0a63;
      --accent2:#6d0d77;
      --text:#ffffff;
      --muted:#b9b9b9;
      --border:#1f1f1f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{width:min(720px, 100%);}
    h1{
      text-align:center;
      font-size:64px;
      margin:0 0 18px 0;
      letter-spacing:2px;
    }
    .row{display:flex; gap:14px;}
    .row > *{flex:1}
    .field, .btn, select{
      width:100%;
      padding:18px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--accent);
      color:var(--text);
      font-weight:700;
      font-size:22px;
      text-transform:uppercase;
      outline:none;
    }
    .field::placeholder{color:#f1dff3; opacity:.75}
    select{appearance:none;}
    .btn{cursor:pointer; transition:.15s;}
    .btn:hover{background:var(--accent2)}
    .btn.secondary{
      background:transparent;
      border:1px solid #2a2a2a;
      color:var(--muted);
      font-weight:600;
      text-transform:none;
      font-size:16px;
      padding:12px 14px;
      border-radius:10px;
    }
    .hint{
      text-align:center;
      color:var(--muted);
      margin-top:10px;
      font-size:14px;
      line-height:1.35;
    }
    .codeBox{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:18px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--accent);
      font-weight:900;
      font-size:30px;
      letter-spacing:4px;
      user-select:text;
    }
    .topActions{display:flex; justify-content:flex-start; margin:0 0 12px 0;}
    .hidden{display:none !important;}
    .small{font-size:14px; color:var(--muted); text-align:center; margin-top:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TBR</h1>

    <!-- ETAPA 1 -->
    <div id="step1">
      <select id="gameSelect" class="field">
        <option value="ito">JOGO</option>
        <option value="quem-sou-eu">QUEM SOU EU?</option>
        <option value="impostor">IMPOSTOR</option>
      </select>

      <input id="nickname" class="field" placeholder="APELIDO" maxlength="20" />

      <div class="row">
        <button class="btn" id="btnGoCreate">CRIAR</button>
        <button class="btn" id="btnGoJoin">ENTRAR</button>
      </div>

      <div class="hint">
        Voc√™ escolhe o jogo e seu apelido.<br/>
        Depois decide se vai <b>criar</b> ou <b>entrar</b> em uma sala.
      </div>
    </div>

    <!-- ETAPA 2 (MESTRE) -->
    <div id="step2" class="hidden">
      <div class="topActions">
        <button class="btn secondary" id="back2">‚Üê Voltar</button>
      </div>

      <div class="codeBox">
        <span id="generatedCode">------</span>
        <button class="btn secondary" id="copyCode">Copiar</button>
      </div>

      <input id="masterPassword" class="field" placeholder="SENHA" maxlength="24" />
      <button class="btn" id="btnCreateRoomFinal">CRIAR</button>

      <div class="small">
        Compartilhe o <b>c√≥digo</b> + a <b>senha</b> com os jogadores.
      </div>
    </div>

    <!-- ETAPA 3 (JOGADOR) -->
    <div id="step3" class="hidden">
      <div class="topActions">
        <button class="btn secondary" id="back3">‚Üê Voltar</button>
      </div>

      <div class="row">
        <input id="joinCode" class="field" placeholder="C√ìDIGO" maxlength="6" />
        <input id="joinPassword" class="field" placeholder="SENHA" maxlength="24" />
      </div>

      <button class="btn" id="btnJoinRoomFinal">ENTRAR</button>

      <div class="small">
        Digite o c√≥digo e a senha que o mestre te enviou.
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let selectedGame = "ito";
    let nickname = "";
    let pendingRoomCode = "";

    function show(step){
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.add("hidden");
      document.getElementById("step3").classList.add("hidden");
      document.getElementById(step).classList.remove("hidden");
    }

    function generateCode(){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    const gameSelect = document.getElementById("gameSelect");
    const nickInput = document.getElementById("nickname");

    const savedNick = localStorage.getItem("tbr_nick");
    if (savedNick) nickInput.value = savedNick;

    document.getElementById("btnGoCreate").onclick = () => {
      selectedGame = gameSelect.value;
      nickname = nickInput.value.trim();
      if (!nickname) return alert("Coloque um apelido.");

      localStorage.setItem("tbr_nick", nickname);

      pendingRoomCode = generateCode();
      document.getElementById("generatedCode").textContent = pendingRoomCode;

      document.getElementById("masterPassword").value = "";
      show("step2");
    };

    document.getElementById("btnGoJoin").onclick = () => {
      selectedGame = gameSelect.value;
      nickname = nickInput.value.trim();
      if (!nickname) return alert("Coloque um apelido.");

      localStorage.setItem("tbr_nick", nickname);

      document.getElementById("joinCode").value = "";
      document.getElementById("joinPassword").value = "";
      show("step3");
    };

    document.getElementById("back2").onclick = () => show("step1");
    document.getElementById("back3").onclick = () => show("step1");

    document.getElementById("copyCode").onclick = async () => {
      try{
        await navigator.clipboard.writeText(pendingRoomCode);
        alert("C√≥digo copiado!");
      }catch(e){
        alert("N√£o deu pra copiar automaticamente. Copie manualmente: " + pendingRoomCode);
      }
    };

    // Etapa 2 -> criar sala
    document.getElementById("btnCreateRoomFinal").onclick = () => {
      const password = document.getElementById("masterPassword").value.trim();
      if (!password) return alert("Digite uma senha.");

      // üëë salva senha s√≥ no navegador do mestre, s√≥ pra n√£o pedir de novo no jogo
      sessionStorage.setItem("tbr_master_password", password);
      sessionStorage.setItem("tbr_master_room", pendingRoomCode);

      socket.emit("createRoom", {
        roomId: pendingRoomCode,
        password,
        masterName: nickname,
        gameType: selectedGame
      });
    };

    // Etapa 3 -> entrar na sala
    document.getElementById("btnJoinRoomFinal").onclick = () => {
      const roomId = document.getElementById("joinCode").value.trim().toUpperCase();
      const password = document.getElementById("joinPassword").value.trim();

      if (!roomId) return alert("Digite o c√≥digo.");
      if (!password) return alert("Digite a senha.");

      socket.emit("joinRoom", {
        roomId,
        password,
        playerName: nickname
      });
    };

    socket.on("errorMessage", (msg) => alert(msg));

    // ‚úÖ redireciona para a p√°gina do jogo
    socket.on("roomCreated", ({ roomId, gameType }) => {
      const url = `/games/${gameType}.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(nickname)}`;
      window.location.href = url;
    });

    socket.on("joinedRoom", ({ roomId, gameType }) => {
      const url = `/games/${gameType}.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(nickname)}`;
      window.location.href = url;
    });
  </script>
</body>
</html>
