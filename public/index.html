<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TBR</title>
  <style>
    body{margin:0;font-family:Arial;background:#0b0b0b;color:#eaeaea;text-align:center;padding:20px}
    .wrap{max-width:640px;margin:0 auto}
    .card{background:#111;border:1px solid #222;border-radius:12px;padding:16px;margin:14px 0}
    .row{display:flex;gap:12px}
    .row>*{flex:1}
    input,select,button{
      width:100%;box-sizing:border-box;padding:14px;border-radius:10px;
      border:1px solid #333;background:#1f1f1f;color:#fff;font-size:16px
    }
    button{cursor:pointer}
    button:hover{background:#2a2a2a}
    .muted{color:#aaa;font-size:13px;line-height:1.4}
    .hidden{display:none !important}
    .code{font-family:ui-monospace,Menlo,monospace;letter-spacing:2px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:10px 0 0 0;">TBR</h1>
    <div class="muted">Plataforma de jogos (versão inicial)</div>

    <div class="card" id="step1">
      <select id="gameSelect">
        <option value="ito">De 1 a 100</option>
        <option value="quem-sou-eu">Eu sou…</option>
        <option value="impostor">Espião</option>
        <option value="infiltrado">Infiltrado</option>
      </select>

      <input id="nickname" placeholder="Seu apelido" maxlength="20" />

      <div class="row" style="margin-top:10px;">
        <button id="btnGoCreate">Criar sala</button>
        <button id="btnGoJoin">Entrar na sala</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Escolha o jogo, coloque seu apelido e crie ou entre em uma sala.
      </div>
    </div>

    <div class="card hidden" id="step2">
      <button id="back2">← Voltar</button>

      <div style="margin:10px 0;">
        Código da sala: <span class="code" id="generatedCode">------</span>
      </div>

      <div class="row">
        <button id="copyCode">Copiar código</button>
        <button id="regenCode">Gerar outro</button>
      </div>

      <input id="masterPassword" placeholder="Senha da sala" maxlength="24" style="margin-top:10px;"/>

      <button id="btnCreateRoomFinal" style="margin-top:10px;">Criar</button>

      <div class="muted" style="margin-top:10px;">
        Envie <b>código</b> + <b>senha</b> pros jogadores.
      </div>
    </div>

    <div class="card hidden" id="step3">
      <button id="back3">← Voltar</button>

      <div class="row" style="margin-top:10px;">
        <input id="joinCode" placeholder="Código" maxlength="6" />
        <input id="joinPassword" placeholder="Senha" maxlength="24" />
      </div>

      <button id="btnJoinRoomFinal" style="margin-top:10px;">Entrar</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function getPlayerToken(){
      let t = localStorage.getItem("tbr_player_token");
      if (!t) {
        t = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random())).toString();
        localStorage.setItem("tbr_player_token", t);
      }
      return t;
    }
    const playerToken = getPlayerToken();

    let selectedGame = "ito";
    let nickname = "";
    let pendingRoomCode = "";

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");

    function showStep(n){
      step1.classList.add("hidden");
      step2.classList.add("hidden");
      step3.classList.add("hidden");
      document.getElementById("step"+n).classList.remove("hidden");
    }

    function generateCode(){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    const gameSelect = document.getElementById("gameSelect");
    const nickInput = document.getElementById("nickname");

    const savedNick = localStorage.getItem("tbr_nick");
    if (savedNick) nickInput.value = savedNick;

    document.getElementById("btnGoCreate").onclick = () => {
      selectedGame = gameSelect.value;
      nickname = nickInput.value.trim();
      if (!nickname) return alert("Coloque um apelido.");
      localStorage.setItem("tbr_nick", nickname);

      pendingRoomCode = generateCode();
      document.getElementById("generatedCode").textContent = pendingRoomCode;
      document.getElementById("masterPassword").value = "";
      showStep(2);
    };

    document.getElementById("btnGoJoin").onclick = () => {
      selectedGame = gameSelect.value;
      nickname = nickInput.value.trim();
      if (!nickname) return alert("Coloque um apelido.");
      localStorage.setItem("tbr_nick", nickname);

      document.getElementById("joinCode").value = "";
      document.getElementById("joinPassword").value = "";
      showStep(3);
    };

    document.getElementById("back2").onclick = () => showStep(1);
    document.getElementById("back3").onclick = () => showStep(1);

    document.getElementById("regenCode").onclick = () => {
      pendingRoomCode = generateCode();
      document.getElementById("generatedCode").textContent = pendingRoomCode;
    };

    document.getElementById("copyCode").onclick = async () => {
      try{
        await navigator.clipboard.writeText(pendingRoomCode);
        alert("Código copiado!");
      }catch(e){
        alert("Copie manualmente: " + pendingRoomCode);
      }
    };

    document.getElementById("btnCreateRoomFinal").onclick = () => {
      const password = document.getElementById("masterPassword").value.trim();
      if (!password) return alert("Digite uma senha.");

      // mantém seu comportamento (não salva senha em localStorage)
      sessionStorage.setItem("tbr_master_password", password);
      sessionStorage.setItem("tbr_master_room", pendingRoomCode);

      socket.emit("createRoom", {
        roomId: pendingRoomCode,
        password,
        masterName: nickname,
        gameType: selectedGame,
        playerToken
      });
    };

    document.getElementById("btnJoinRoomFinal").onclick = () => {
      const roomId = document.getElementById("joinCode").value.trim().toUpperCase();
      const password = document.getElementById("joinPassword").value.trim();

      if (!roomId) return alert("Digite o código.");
      if (!password) return alert("Digite a senha.");

      sessionStorage.setItem("tbr_join_password", password);
      sessionStorage.setItem("tbr_join_room", roomId);

      socket.emit("joinRoom", {
        roomId,
        password,
        playerName: nickname,
        playerToken
      });
    };

    socket.on("errorMessage", (msg) => alert(msg));

    function goToGame({ roomId, gameType, sessionKey }){
      sessionStorage.setItem(`tbr_session_${roomId}`, sessionKey);

      // ✅ envia token + sessionKey via URL (o infiltrado.html usa isso)
      const url =
        `/games/${gameType}.html` +
        `?room=${encodeURIComponent(roomId)}` +
        `&name=${encodeURIComponent(nickname)}` +
        `&token=${encodeURIComponent(playerToken)}` +
        `&sessionKey=${encodeURIComponent(sessionKey)}`;

      window.location.href = url;
    }

    socket.on("roomCreated", ({ roomId, gameType, sessionKey }) => {
      goToGame({ roomId, gameType, sessionKey });
    });

    socket.on("joinedRoom", ({ roomId, gameType, sessionKey }) => {
      goToGame({ roomId, gameType, sessionKey });
    });
  </script>
</body>
</html>
